# Kratos Machine Learning Models

Included in the Kratos packages are 6 machine learning models, 5 developed with the Tensorflow framework and 1 with the PyTorch framework. These models will make predictions on an image of an article of clothing, predictions include the color of the item, the category of clothing it falls under, and some attributes of the item.

## Predictions

### Color
The color prediction model was developed in the PyTorch framework to predict the color of the clothes in images.  
The initial training images and labels are from the DeepFashion dataset [In-Shop Clothes Retrieval Benchmark](https://drive.google.com/drive/folders/0B7EVK8r0v71pVDZFQXRsMDZCX1E) partition. At current stage, the model is capable of predicting one result like Oatmeal-indigo, Wine-cream and Orange-navy for an image that contains a person wearing clothing of multiple colors.  
Data from the Deep Fashion dataset has been pre-processed into a set of five text files.

* [allcolor.txt](https://github.com/kratos-ai/Kratos/blob/master/color/allcolor.txt) - The list of color labels  
* [traindataset.txt](https://github.com/kratos-ai/Kratos/blob/master/color/traindataset.txt) - The list of images from the Deep fashion dataset used for the training data  
* [testdataset.txt](https://github.com/kratos-ai/Kratos/blob/master/color/testdataset.txt) - The list of images from the Deep Fashion dataset used for the testing data  
* [trainlabelset.txt](https://github.com/kratos-ai/Kratos/blob/master/color/trainlabelset.txt) - The list of labels accompanying the traindataset.txt data  
* [testlabelset.txt](https://github.com/kratos-ai/Kratos/blob/master/color/testlabelset.txt) - The list of labels accompanying the testdataset.txt data  

These files are generated by the [datapipline\_update.py](https://github.com/kratos-ai/Kratos/blob/master/color/datapipeline_update.py) file from the `list_color_cloth.txt` and `list_eval_partition.txt` files contained in the [In-Shop Clothes Retrieval Benchmark](https://drive.google.com/drive/folders/0B7EVK8r0v71pVDZFQXRsMDZCX1E) partition Anno and Eval directories, respectively.  

### Categorical
The categorical prediction models were developed using Tensorflow to predict categorical information about clothing in images.

The initial training images and labels are from the DeepFashion dataset [Category and Attribute Prediction Benchmark](https://drive.google.com/drive/folders/0B7EVK8r0v71pWGplNFhjc01NbzQ) partition.

### Attribute
The attribute prediction models were developed with the Tensorflow framework to predict a set of attributes about clothing in an image.

The initial training images and labels are from the DeepFashion dataset [Category and Attribute Prediction Benchmark](https://drive.google.com/drive/folders/0B7EVK8r0v71pWGplNFhjc01NbzQ) partition.

Attributes refers to descriptions of five separate types; the texture, fabric, shape, part, or style of an article of clothing. The attribute predictions may return multiple instances of an attribute type with each prediction.

We found in our development that the large selection of attribute options was detrimental to the machine learning. [Attributes model #1](models.md#predict-attribute-1) separates each of the 5 categories into a separate machine learning task. This was able to vastly improve the capabilities of accurate predictions when compared with [Attributes model #2](models.md#predict-attribute-2).

## Run a predictor
Please see the [UI page](ui.md) for operation of the Kratos models through the UI interface.

To run a prediction of a single model over an image or a set of images, the following files within that model architecture will need to be modified and executed.

### Predict Color
To make a prediction using the color prediction model, execute the `img_test.py` file. Modifications to the script will need to be made for the path of the desired image `path` and the path to the weights `test.pth`.  
This script needs the allcolor.txt file generated by the [datapipline\_update.py](https://github.com/kratos-ai/Kratos/blob/master/color/datapipeline_update.py) script.

### Predict Category #1
To make a prediction using category prediction model #1, a new .py file will have to be created.

    import tensorflow as tf
    from tensorflow import keras
    import data_precess as dp    
    import reload_model as rm
    import category_model as cm

    model = cm.create_model()
    model.load_weights('model_weights.h5')
	#<file> can be either a path to an image, or a text file containing multiple image paths, one per line.
    predictions = rm.predict(model, <file>)
    print(predictions)

The category model #1 will return the top 5 predictions for each image.

### Predict Category #2 
To make a prediction using category prediction model #2, a new .py file will have to be created.

    from inference import predict

    # <file> is the path to an image
    predictions = predict(<file>)
    print(predictions)


The category model #2 will return the top 5 predictions for the image.


### Predict Category #3
To make a prediction using category prediction model #3, execute the `predict_vgg19.py` file. Modifications to the script will need to be made for the `filenames` variable. Create a list with the paths of each image for which you wish to make a prediction.

### Predict Attribute #1
To make a prediction using attribute prediction model #1, execute the `Agent.py` file. Modifications to the script will need to be made for the `image_path` and `dir_models` variables; for the paths to the image on which to predict and the path to the model respectively.  

### Predict Attribute #2
To make a prediction using attributes prediction model #2, execute the `runModel.py` file.  
Pass the `-i <image_path>` argument to run the model over a specific image.  
Pass the `-m <model_path>` argument to load specific weights.  
The `FLAGS.test_list` variable can point to a text file containing image paths (one per line). If the `-i` argument is not used, predictions will be made over images found within this text file.

## Retraining
To execute a retraining over the same or a new dataset, the following files will need to be modified and executed.

### Retrain Color
The python file [capstone\_test.py](https://github.com/kratos-ai/Kratos/blob/master/color/capstone_test.py) contains the code for training the color predictor model.
To retrain the color model, the four train and test files generated by the [datapipeline\_update.py](models.md#color) are required.  
To vary the number of epochs the model will train over, edit the range over which `intEpoch` is run.
To save the model after each epoch, uncomment the final line. To change the name of the save file, change `./test.pth`

### Retrain Category #1
The python file [train\_test.py](https://github.com/kratos-ai/Kratos/blob/master/category1/train_test.py) contains the code for training the category predictor model #1.  
To retrain this model, execute the `train_test.py` python file, epochs can be modified within the `Info.epochs` variable

The path to the main dataset file will need to be modified, the `PROPERTY.path` variable in the `data_processor.py` file.  

If training with [expanded labels](labels.md#categories), the `PROPERTY.CATEGORIES` list in `data_processor.py` will need to be manually updated with the new category names.

### Retrain Category #2
The python file [model.py](https://github.com/kratos-ai/Kratos/blob/master/category2/model.py) contains the code necessary to train the model.  
You can modify the architecture of the network, or tweak other hyperparameters there. Additionally by either changing the file paths, or appending to the `list_eval_partition.txt` file you can choose which images you want to train on as well as which should be in your validation, and test sets.

The path to the main dataset directory ill need to be modified, the `FLAGS.data_dir` variable in `model.py`.

If training with [expanded labels](labels.md#categories), the `FLAGS.classes` list in `model.py` will need to be manually updated with the new number of categories.

### Retrain Category #3
The python file [load\_and\_train\_vgg19.py](https://github.com/kratos-ai/Kratos/blob/master/category3/load_and_train_vgg19.py) contains the code for training the category predictor model #3.  
To retrain this model, execute the `load_and_train_vgg19.py`. This code is designed to run one epoch.  
Further epochs are to be run from the `continue_training_vgg19.py` file. This file will use the weights created by `load_and_train_vgg19.py` for continued training.

The path to the main dataset directory will need to be modified, the `MODDED.data_dir` variable in the `model_architecture_vgg19.py` file.

If training with [expanded labels](labels.md#categories), the `MODDED.classes` and `MODDED.CATEGORIES` list in `model_architecture_vgg19.py` will need to be manually updated with the new number of categories and new category names.

### Retrain Attribute #1
The python file [KratosAttributesTrainingModel.py](https://github.com/kratos-ai/Kratos/blob/master/attribute1/KratosAttributesTrainingModel.py) contains the code for training the attributes predictor model #1.  
To retrain this model, new pickle format data files will need to be created. To do this, execute the `DeepFashionDataPreprocessing.py` script. This expects the `list_attr_cloth.txt` & `list_eval_partition` files from the Category and Attribute Prediction Benchmark directory to be in the same directory as `DeepFashionDataPreprocessing.py`. This wil create two files, `DataSet.pickle` & `Attributes.pickle`.  
Once the `.pickle` files have been created, `KratosAttributesTraininModel.py` can be run. This model has split the 5 sub-categories of attributes into separate learning tasks and will run for each of them sequentially.


### Retrain Attribute #2
The python file [attributes.py](https://github.com/kratos-ai/Kratos/blob/master/attribute2/attributes.py) contains the code for training the attributes predictor #2.  
To retrain this model, execute the `attributes.py` file.

The path to the main dataset directory will need to be modified, the `FLAGS.data_dir` variable in the `model_setup.py` file.

If training with [expanded labels](labels.md#attributes), the `FLAGS.classes` variable in `model_setup.py` will need to be manually updated with the new number of attributes.  
